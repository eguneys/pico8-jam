pico-8 cartridge // http://www.pico-8.com
version 29
__lua__

dbg = ""

t_max = 20
v_max = 16
x_friction = 5 / t_max
h_accel = v_max * x_friction

objects = {}
objects2 = {}

function _init()
   poke(0x5f2c, 3)
   cls()

   init_room()
end

function init_room()
   init_object(player, 20, 20)
end

function object_move(obj)

   local amount = 0

   // dbg = obj.dy

   obj.remx += obj.dx
   amount = flr(obj.remx)
   obj.remx -= amount
   
   object_move_x(obj, amount)
   
   obj.remy += obj.dy
   amount = flr(obj.remy)
   obj.remy -= amount

   object_move_y(obj, amount)
end

function object_move_y(obj,
                       amount)

   if (amount == 0) then
      return
   end

   local step = sgn(amount) / 8
   for i=0,abs(amount) do
      if not is_solid(obj, 0, step) then
         obj.y += step
      else
         obj.dy = 0
         break
      end
   end
end

function object_move_x(obj, 
                       amount)
   
   if (amount == 0) then 
      return 
   end
   
   local step = sgn(amount) / 8
   for i=0,abs(amount) do
      if not is_solid(obj, step, 0) then
         obj.x += step
      else
         obj.dx = 0
         break
      end
   end
end


function object_init()
end

function object_update()
end

function object_draw()
end

baseobject = {
   remx=0,
   remy=0,
   x=0,
   y=0,
   dx=0,
   dy=0,
   layer=objects,
   collideable=true,
   init=object_init,
   move=object_move,
   update=object_update,
   draw=object_draw,
   cbox={ x=0,y=0,w=8,h=8 },
   flipx=false,
   flipy=false
}

function init_object(type,x,y)
   local obj = {}

   merge(obj, baseobject)
   merge(obj, type)
   
   obj.type=type
   obj.x = x
   obj.y = y

   add(obj.layer, obj)

   obj.init(obj)

   return obj
end

function destroy_object(obj)
   del(obj.layer, obj)
end

function player_update(p)
   local input_x = 0
   local input_y = 0

   if btn(⬆️) then
      input_y = -1
   elseif btn(⬇️) then
      input_y = 1
   end
   if btn(⬅️) then
      input_x = -1
   elseif btn(➡️) then
      input_x = 1
   end

   if input_x != 0 and input_y != 0 then
      input_x *= 0.6
      input_y *= 0.6
   end

   local _x_accel = h_accel * input_x
   local _y_accel = h_accel * input_y

   p.dx += _x_accel
   p.dx += -p.dx * x_friction

   p.dy += _y_accel
   p.dy += -p.dy * x_friction

   p.flipx = p.dx < 0

   local running = abs(p.dx) + abs(p.dy) > 1

   if running and p.l % 2 + rnd(1) < 1 then
      init_object(smoke, p.x + 4, p.y + 8)
   end

   local facing_idle = (p.dx == 0 and p.dy == 0) or (input_x == 0 and input_y == 0)
   local facing_up = p.dy < 0 and input_y < 0
   local facing_down = p.dy > 0 and input_y > 0
   local facing_horizontal = p.dx != 0 and input_x != 0

   if facing_idle then
      p.spr = 17
   elseif facing_up then
      p.spr = 33
   elseif facing_down then
      p.spr = 49
   elseif facing_horizontal then
      p.spr = 1
   end

   p.l += 0.3
end

function player_draw(p)
   local spr = p.spr + (p.l % 3)
   local sx = flr(spr % 16) * 8
   local sy = flr(spr / 16) * 8
   //spr(p.spr, p.x, p.y,1,1,p.flipx,p.flipy)
   sspr(sx, sy, 8, 8, p.x, p.y, 8, 8, p.flipx, p.flipy)
end

player = {
   spr = 1,
   l = 0,
   layer=objects2,
   cbox={ x=1,y=4,w=6,h=4 },
   update=player_update,
   draw=player_draw
}

function smoke_init(s)
   s.dy=0.1
   s.dx=-0.3+rnd(0.2)
   s.x+=-1+rnd(2)
   s.y+=-1+rnd(2)
   s.flipx=maybe()
   s.flipy=maybe()   
end

function smoke_update(s)
   s.l += 0.4
   if (s.l >= 4) then
      destroy_object(s)
   end
end

function smoke_draw(s)
   local sx = flr(s.spr % 16) * 8
   local sy = flr(s.spr / 16) * 8

   sx += flr(s.l) * 4

   sspr(sx, sy, 4, 4, s.x, s.y - 4, 4, 4, s.flipx, s.flipy)
end

smoke = {
   spr = 12,
   l = 0,
   init=smoke_init,
   update=smoke_update,
   draw=smoke_draw
}

function _update()
   cls()

   map(0, 0, 0, 0)

   for obj in all(objects) do
      obj.move(obj)
      obj.update(obj)
   end

   for obj in all(objects2) do
      obj.move(obj)
      obj.update(obj)
   end

   print(dbg, 0, 0, 1)
end

function _draw()
   for obj in all(objects) do
      obj.draw(obj)
   end

   for obj in all(objects2) do
      obj.draw(obj)
   end
end

-->8

function merge(base, extend)
   for k,v in pairs(extend) do
      base[k] = v
   end
end


function maybe()
   return rnd(1)<0.5
end

function sign(v)
	return v>0 and 1 or
								v<0 and -1 or 0
end

function appr(val,target,amount)
 return val > target 
 	and max(val - amount, target) 
 	or min(val + amount, target)
end

function clamp(val,a,b)
	return max(a, min(b, val))
end

function tile_at(x,y)
   return mget(x, y)
end

function tile_flag_at(x,y,w,h)
   for i=max(0,flr(x/8)),
   min(15, (x+w-1)/8) do
      for j=max(0,flr(y/8)),
      min(15,(y+h-1)/8) do
         if fget(tile_at(i,j),flag) then
            return true
         end
      end
   end
   return false
end

tile_cboxes = {
   {f=0,cbox={x=0,y=0,w=4,h=8}},
   {f=1,cbox={x=4,y=0,w=4,h=8}},
   {f=2,cbox={x=0,y=0,w=8,h=4}},
   {f=3,cbox={x=0,y=4,w=8,h=4}}
}

function cboxes_at(x,y,w,h)
   local res = {}
   for i=max(0,flr(x/8)),
   min(15, (x+w-1)/8) do
      for j=max(0,flr(y/8)),
      min(15,(y+h-1)/8) do
         for tile_cbox in all(tile_cboxes) do
            if fget(tile_at(i,j),
                    tile_cbox.f) then

               local _abs_cbox = {
                  w=tile_cbox.cbox.w,
                  h=tile_cbox.cbox.h,
                  x=tile_cbox.cbox.x+i*8,
                  y=tile_cbox.cbox.y+j*8
               }

               add(res, _abs_cbox)
            end
         end
      end
   end
   return res
end

function box_intersects(a, b)
   return a.x + a.w > b.x and
      a.y + a.h > b.y and
      a.x < b.x + b.w and
      a.y < b.y + b.h
end

function solid_at(cbox)
   local cboxes = cboxes_at(cbox.x,cbox.y,cbox.w,cbox.h)

   for cbox2 in all(cboxes) do
      if box_intersects(cbox, cbox2) then
         return true
      end
   end
   return false
end


function is_solid(obj, x, y)
   local cbox = abs_cbox(obj)
   cbox.x += x
   cbox.y += y

   return solid_at(cbox)
end


function abs_cbox(obj)
   local box = {
      w=obj.cbox.w,
      h=obj.cbox.h}
   box.x = obj.x+obj.cbox.x
   box.y = obj.y+obj.cbox.y
   return box
end

__gfx__
00000000007800000078000000780000000000000000000000000000000000000000000000000000000000000000000000000000007000000000000000000000
00000000077888800778888007788880000000000000000000000000000000000000000000000000000000000000000000000700000700000000000000000000
00700700078887100788871007888710000000000000000000000000000000000000000000000000000000000000000077007000000000070000000000000000
00077000088881100888811008888110000000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000
00077000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000022222200222222002222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000010000100010100000100100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000078007800780078007800780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000071887100718871007188710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000011881100118811001188110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000022222200222222002222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000010000100100001001000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000078007800780078007800780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000022222200222222002222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000010000100100000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000078007800780078007800780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000071887100718871007188710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000011881100118811001188110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000012222200222222002222210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000100100001001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d777777d7777777d7777777d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7d77777d7777777d777777d700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77566665666666656666657700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77656665666666656666567700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77665555555555555555667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77665333333333333335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77665333f33333333335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7766533ffff333f3f33555dd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd555333ffffffffff35667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7766533ffffffffff335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77665333fffffffff335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77665333ffffffff3335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77665333ffffffff3335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7766533fffffffff3335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7766533ffffffffff335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
776653ffffffffff333555dd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd55533f3f333ffff335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
776653333333333f3335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77665333333333333335667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77665555555555555555667700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77656666566666665666567700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77566666566666665666657700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7d777777d7777777d77777d700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d7777777d7777777d777777d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000077000000770000007700000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777007777770077777700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777ff100777ff100777ff100000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777fff00777fff00777fff00000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777007777770077777700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccc00cccccc00cccccc00000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111f01111110f11111100000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff1111f001ffff100f1111ff0000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000770077007700770077007700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777007777770077777700000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000071ff170071ff170071ff1700000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007ffff7007ffff7007ffff700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777007777770077777700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccc00cccccc00cccccc00000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111100f111110011111f00000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff11ff00ff111f00f111ff00000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000770077007700770077007700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777007777770077777700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777007777770077777700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777007777770077777700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777007777770077777700000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccc00cccccc00cccccc00000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f11111001111110011111f00000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff111f00ff11ff00f111ff00000000000000000
__gff__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050406000000000000000000000000000100020000000000000000000000000009080a0000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
4041514141414142000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051515151515152000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051515151515152000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051515151515151000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051515151515152000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5151515151515152000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051515151515152000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6061616161616162000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
