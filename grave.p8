pico-8 cartridge // http://www.pico-8.com
version 29
__lua__

dbg= ""

function init_player(p)
end

-- ⬆️⬇️⬅️➡️❎🅾️
function update_player(p)

   local inputx=0
   local inputy=0
   
   if btn(⬆️) then
      inputy = -1
   elseif btn(⬇️) then
      inputy = 1
   end

   if btn(⬅️) then
      inputx = -1
   elseif btn(➡️) then
      inputx = 1
   end

   p.x += inputx


   cam.targetx = p.x - 64
   cam.targety = p.y - 64
end

function draw_player(p)
   spr(49, p.x, p.y)
end

player = {
   x=0,
   y=0,
   init=init_player,
   update=update_player,
   draw=draw_player
}

function init_object(objects, type, x, y, m)
   local obj = {}

   merge(obj, type)

   obj.x = x
   obj.y = y

   obj.init(obj, m)

   add(objects, obj)

   return obj
end

function _init()
   cam = {
      x=0,
      y=0,
      targetx=0,
      targety=0
   }

   pworld = {
      0, 1, 2, 5, 3, 4, 5, 1,
      5, 3, 4, 5, 3, 4, 5, 3,
      5, 1, 2, 5, 1, 2, 5, 1,
      5, 1, 2, 5, 1, 2, 5, 1,
   }

   oworld = {
   }

   for i=0,7 do
      for j=0,3 do
         local objects = {}
         oworld[j*8+i+1] = objects

         load_chunk(objects, i*128, j*128)
      end
   end

end

function load_chunk(objects, x, y)
   local cel = pos2cel(x,y)
   for i=0,16 do
      for j=0,16 do
         local m = mget(cel.x+i, cel.y+j)
         local type
         if m == 49 then
            type = player
         end

         if type then
            init_object(objects, type, x+i*8, y+j*8)
         end
      end
   end
end

function pos2cel(x, y)
   local chunk = pworld[flr(x/128)+flr(y/128)*8+1]

   return chunk and {
      x=chunk%8*16,
      y=flr(chunk/8)*16
   }
end

function _update()

   for objects in all(oworld) do
      for obj in all(objects) do
         obj.update(obj)
      end
   end

   cam.x = lerp(cam.x, cam.targetx, 0.2)
   cam.y = lerp(cam.y, cam.targety, 0.2)

   cam.x = clamp(cam.x, 0, 7 * 128)
   cam.y = clamp(cam.y, 0, 3 * 128)
end

-- 0 0 0 0
-- 16 16 0 0, 1 0
-- 128 128 1 0

function _draw()
   cls()

   camera(cam.x, cam.y)

   local sx = flr(cam.x/128)*128
   local sy = flr(cam.y/128)*128
   local cel1 = pos2cel(sx,sy)
   local cel2 = pos2cel(sx+128,sy)
   local cel3 = pos2cel(sx,sy+128)
   local cel4 = pos2cel(sx+128,sy+128)

   if cel1 then
      map(cel1.x, cel1.y, sx, sy, 16, 16, 1)
   end
   if cel2 then
      map(cel2.x, cel2.y, sx+128, sy, 16, 16, 1)
   end
   if cel3 then
      map(cel3.x, cel3.y, sx, sy+128, 16, 16, 1)
   end
   if cel4 then
      map(cel4.x, cel4.y, sx+128, sy+128, 16, 16, 1)
   end


   for objects in all(oworld) do
      for obj in all(objects) do
         obj.draw(obj)
      end
   end

   camera()
   print(dbg, 0, 0,2)
end

-->8

function merge(extend, base)
   for key,value in pairs(base) do
      extend[key] = value
   end
end

function clamp(value, _min, _max)
   if value < _min then 
      return _min
   elseif value > _max then
      return _max
   else 
      return value
   end
end

function appr(value, target, amount)
   if value < target then
      return min(target, value + amount)
   elseif value > target then
      return max(target, value - amount)
   else
      return target
   end
end

function lerp(value, target, factor)
   return value + (target - value) * factor
end


__gfx__
0000000007cccc700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000761111670000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700c111111c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000c111111c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000c111111c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700c111111c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000761111670000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000007cccc700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000028ff77000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000028fff7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000028ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000056885700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000057885600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000002882000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000cccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000004904900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010101000000000000010000000000000001010000000000000100000000000000010100000000000001000000000000000101000000000000010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000100000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000100000000000000000000000000000001010100000000000000000000000000010101000000000000000000000000000100010000000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000100000000000000000000000000000000000100000000000000000000000000000001000000000000000000000000000100010000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000100000000000000000000000000000001010100000000000000000000000000010101000000000000000000000000000101010000000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000100000000000000000000000000000001000000000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000100000001000000000000000100000001010100000000000000000001000000010101000000000000000000010000000000010000000000000000000100000001010100000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000100000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000003100000000000000000000000001000000000000000000000000000000010000000000000000000000000000000100000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
